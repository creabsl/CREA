/**
 * Migration Script: Remove memberId from User table
 * This script:
 * 1. Drops the memberId index from User collection
 * 2. Removes memberId field from all users
 * 3. All membership IDs are now managed by Membership table only (CREA2025XXXX format)
 */

require('dotenv').config();
const mongoose = require('mongoose');
const User = require('../models/userModel');

const MONGODB_URI = process.env.MONGO_URI || 'mongodb://localhost:27017/crea';

async function migrate() {
  try {
    console.log('ğŸ”Œ Connecting to MongoDB...');
    await mongoose.connect(MONGODB_URI);
    console.log('âœ… Connected to MongoDB');

    // Drop the memberId index
    console.log('\nğŸ—‘ï¸  Dropping memberId index from User collection...');
    try {
      await User.collection.dropIndex('memberId_1');
      console.log('âœ… memberId index dropped successfully');
    } catch (error) {
      if (error.code === 27 || error.message.includes('index not found')) {
        console.log('â„¹ï¸  Index already does not exist');
      } else {
        throw error;
      }
    }

    // Remove memberId field from all users
    console.log('\nğŸ§¹ Removing memberId field from all users...');
    const result = await User.updateMany(
      { memberId: { $exists: true } },
      { $unset: { memberId: '' } }
    );
    console.log(`âœ… Removed memberId from ${result.modifiedCount} users`);

    console.log('\nğŸ“Š Migration Summary:');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ“ User table: memberId field removed');
    console.log('âœ“ Index: memberId_1 dropped');
    console.log('âœ“ Membership IDs now come from Membership table only');
    console.log('âœ“ Format: CREA2025XXXX (auto-generated by Membership model)');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');

    console.log('ğŸ‰ Migration completed successfully!\n');
    
  } catch (error) {
    console.error('âŒ Migration failed:', error);
    process.exit(1);
  } finally {
    await mongoose.connection.close();
    console.log('ğŸ”Œ MongoDB connection closed');
  }
}

// Run migration
migrate();
